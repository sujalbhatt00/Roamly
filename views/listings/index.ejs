<% layout("/layouts/boilerplate") %>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  /* --- Design System Variables --- */
  :root {
    --roamly-red: #E54D42;
    --roamly-red-rgb: 229, 77, 66;
    --roamly-dark-red: #c9302c;
    --roamly-light-gray: #f8f9fa;
    --roamly-border-gray: #e0e0e0;
    --roamly-text-dark: #222222;
    --roamly-text-medium: #717171;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.06);
    --shadow-md: 0 5px 15px rgba(0,0,0,0.1);
    --border-radius-sm: 8px;
    --border-radius: 12px;
  }

  body {
    font-family: 'Inter', sans-serif;
    background-color: #fff;
    color: var(--roamly-text-dark);
  }

  .page-container {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  /* --- Sticky Filter Bar & Tax Toggle Container --- */
  #header-sticky-container { /* Wraps filters and tax toggle */
    position: sticky;
    top: 80px; /* Height of your navbar */
    background-color: #fff;
    z-index: 100;
    border-bottom: 1px solid var(--roamly-border-gray);
    padding: 0 2rem; /* Consistent padding */
  }

  #filters {
    display: flex;
    align-items: center;
    gap: 2.5rem;
    overflow-x: auto;
    padding: 1rem 0; /* Vertical padding */
    margin: 0;
    scroll-behavior: smooth;
    width: 100%;
  }

  #filters::-webkit-scrollbar { height: 4px; }
  #filters::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 2px; }

  .filter {
    text-align: center;
    opacity: 0.7;
    color: var(--roamly-text-dark);
    text-decoration: none;
    transition: all 0.2s;
    flex: 0 0 auto;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid transparent;
  }
  .filter:hover {
    opacity: 1;
    color: var(--roamly-text-dark);
    border-bottom-color: var(--roamly-border-gray);
    cursor: pointer;
  }
  .filter i { font-size: 1.5rem; }
  .filter p { font-size: 0.8rem; margin: 0.3rem 0 0; font-weight: 500; white-space: nowrap; }

  /* --- Tax Toggle (Centered Below Filters) --- */
  .tax-toggle-container { /* Separate container for centering */
    display: flex;
    justify-content: center;
    align-items: center;
    padding-bottom: 1rem; /* Padding below toggle */
  }
  .tax-toggle {
    border: 1px solid var(--roamly-border-gray);
    border-radius: var(--border-radius);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #fff;
    box-shadow: var(--shadow-sm);
    width: fit-content; /* Size to content */
  }
  .tax-toggle .form-check-label { font-weight: 500; white-space: nowrap; }

  /* --- Grid Container --- */
  .listings-container {
    padding: 2.5rem 2rem;
  }

  /* --- Airbnb-Style Card --- */
  .listing-card { border: none; background: #fff; position: relative; }
  .listing-link { text-decoration: none; color: inherit; }
  .listing-link:hover .uniform-img { filter: brightness(0.95); }

  .img-ratio-box { position: relative; width: 100%; padding-top: 80%; overflow: hidden; border-radius: var(--border-radius); }
  .uniform-img { position: absolute; width: 100%; height: 100%; object-fit: cover; top: 0; left: 0; transition: filter 0.2s ease; }

  .wishlist-icon { position: absolute; top: 1rem; right: 1rem; z-index: 10; font-size: 1.5rem; color: #fff; text-shadow: 0 1px 4px rgba(0,0,0,0.5); cursor: pointer; }

  /* --- UPDATED BADGE STYLE --- */
  .user-booked-badge {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background-color: #0d6efd; /* Blue for user's booking */
    color: white;
    padding: 0.3rem 0.7rem;
    font-weight: 600;
    border-radius: var(--border-radius-sm);
    z-index: 10;
    font-size: 0.85rem;
  }

  .card-body { padding: 1rem 0 0 0; }
  .card-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem; color: var(--roamly-text-dark); }
  .card-text { color: var(--roamly-text-medium); margin-bottom: 0.25rem; font-size: 0.95rem; }
  .card-price { margin-top: 0.5rem; font-size: 1rem; }
  .card-price strong { color: var(--roamly-text-dark); font-weight: 600; }
  .taxinfo { font-weight: 400; color: var(--roamly-text-medium); font-size: 0.95rem; }

  /* --- Empty State --- */
  .empty-state { grid-column: 1 / -1; text-align: center; padding: 4rem 0; }
  .empty-state h5 { font-size: 1.5rem; font-weight: 600; color: var(--roamly-text-dark); }
  .empty-state p { color: var(--roamly-text-medium); margin-bottom: 0; }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .page-container, #header-sticky-container { padding: 0 1rem; }
    .listings-container { padding: 2rem 1rem; }
    #header-sticky-container { top: 64px; /* Mobile navbar height */ }
    #filters { gap: 1.75rem; }
    .tax-toggle { width: 100%; justify-content: flex-start; }
  }

</style>

<div id="header-sticky-container">
  <div id="filters">
    <a href="/listings" class="filter">
      <div><i class="fa-solid fa-globe"></i></div>
      <p>All Properties</p>
    </a>
    <a href="/listings/category/Trending" class="filter">
      <div><i class="fa-solid fa-fire"></i></div>
      <p>Trending</p>
    </a>
    <a href="/listings/category/Rooms" class="filter">
      <div><i class="fa-solid fa-bed"></i></div>
      <p>Rooms</p>
    </a>
    <a href="/listings/category/Iconic Cities" class="filter">
      <div><i class="fa-solid fa-mountain-city"></i></div>
      <p>Iconic Cities</p>
    </a>
    <a href="/listings/category/Mountain" class="filter">
      <div><i class="fa-solid fa-mountain"></i></div>
      <p>Mountain</p>
    </a>
    <a href="/listings/category/Castles" class="filter">
      <div><i class="fa-brands fa-fort-awesome"></i></div>
      <p>Castles</p>
    </a>
    <a href="/listings/category/Amazing pools" class="filter">
      <div><i class="fa-solid fa-person-swimming"></i></div>
      <p>Amazing Pools</p>
    </a>
    <a href="/listings/category/Camping" class="filter">
      <div><i class="fa-solid fa-campground"></i></div>
      <p>Camping</p>
    </a>
    <a href="/listings/category/Farms" class="filter">
      <div><i class="fa-solid fa-cow"></i></div>
      <p>Farms</p>
    </a>
    <a href="/listings/category/Arctic" class="filter">
      <div><i class="fa-solid fa-snowflake"></i></div>
      <p>Arctic</p>
    </a>
    <a href="/listings/category/Boats" class="filter">
      <div><i class="fa-solid fa-ship"></i></div>
      <p>Boats</p>
    </a>
  </div>

  <div class="tax-toggle-container"> <div class="tax-toggle">
      <div class="form-check-reverse form-switch m-0">
        <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
        <label class="form-check-label ms-2" for="flexSwitchCheckDefault">
          Display total price (incl. tax)
        </label>
      </div>
    </div>
  </div>
</div>

<div class="page-container listings-container">
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4 listings-grid">
    <% if (allListing.length === 0) { %>
      <div class="empty-state">
        <h5>No listings found.</h5>
        <p>Try adjusting your search or filters to find what you're looking for.</p>
      </div>
    <% } %>

    <%# Loop through all listings %>
    <% for(let listing of allListing){ %>
      <%
        // **UPDATED LOGIC**: Check if the CURRENT USER has booked THIS listing.
        // 'userBookedListingIds' is a Set passed from your routes (listing.js).
        // It only contains IDs if a user is logged in AND has bookings.
        const isBookedByUser = typeof userBookedListingIds !== 'undefined' && userBookedListingIds.has(listing._id.toString());
      %>

      <div class="col">
        <a href="/listings/<%=listing._id%>" class="listing-link">
          <div class="listing-card">

            <i class="fa-regular fa-heart wishlist-icon"></i>

            <% if(isBookedByUser){ %>
              <span class="user-booked-badge">You Booked</span>
            <% } %>

            <div class="img-ratio-box">
              <img
                src="<%= listing.image?.url || 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800&h=600&fit=crop' %>"
                class="card-img-top uniform-img"
                alt="<%=listing.title%>"
                loading="lazy"
                onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800&h=600&fit=crop';">
            </div>

            <div class="card-body">
              <h5 class="card-title"><%=listing.location%>, <%=listing.country%></h5>
              <p class="card-text"><%=listing.title%></p>
              <p class="card-price mb-0">
                <strong>â‚¹<%= listing.price ? listing.price.toLocaleString("en-in") : "N/A" %></strong> /night
                <i class="taxinfo" style="display: none;">&nbsp;+ 18%tax</i>
              </p>
            </div>

          </div>
        </a>
      </div>
    <% } %>
  </div>
</div>

<script>
  // Keep the tax toggle script
  const toggle = document.getElementById('flexSwitchCheckDefault');
  toggle.addEventListener('click', () => {
    document.querySelectorAll('.taxinfo').forEach(info => {
      info.style.display = (info.style.display === 'inline-block') ? 'none' : 'inline-block';
    });
  });
</script>
