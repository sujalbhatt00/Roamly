<% layout("/layouts/boilerplate") %>

<div class="container my-5">

  <!-- PROPERTY IMAGE & TITLE -->
  <div class="row mb-4">
    <div class="col-lg-10 offset-lg-1">
      <div class="rounded-4 overflow-hidden shadow-sm mb-3">
         
        <img 
              src="<%= listing.image?.url || 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800&h=600&fit=crop' %>"
                class="card-img-top uniform-img" 
                 alt="Listing Image"
             class="w-100"
             style="height:500px; object-fit:cover;"
               onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800&h=600&fit=crop'">
            
      </div>

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div>
          <h1 class="fw-bold mb-1" style="font-size:2.5rem;"><%= listing.title %></h1>
          <div class="d-flex align-items-center gap-2 text-muted">
            <i class="fa-solid fa-location-dot text-danger"></i>
            <span><%= listing.location %>, <%= listing.country %></span>
          </div>
        </div>
        <div class="mt-3 mt-md-0 fs-4 fw-semibold text-danger">
          ₹<%= listing.price ? listing.price.toLocaleString("en-in") : "N/A" %> / night
        </div>
      </div>
    </div>
  </div>

  <!-- OWNER + DESCRIPTION + ACTIONS -->
  <div class="row mb-5">
    <div class="col-lg-10 offset-lg-1">
      <div class="p-4 bg-white rounded-4 shadow-sm">
        <div class="d-flex align-items-center mb-3">
          <img src="<%= listing.owner?.avatar || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %>"
               alt="Owner"
               class="rounded-circle me-3 shadow-sm"
               style="width:55px; height:55px; object-fit:cover;">
          <p class="mb-0 fw-semibold">Hosted by <%= listing.owner?.username || 'sujalbhatt' %></p>
        </div>

        <p class="text-muted mb-4"><%= listing.description %></p>

        <div class="d-flex gap-3 flex-wrap">
          <% if (currUser && listing.owner && (listing.owner._id.equals(currUser._id) || currUser.username === 'sujalbhatt')) { %>
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark px-4">Edit</a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
              <button type="submit" class="btn btn-outline-danger px-4">Delete</button>
            </form>
          <% } %>
          <button class="btn btn-danger px-4" data-bs-toggle="modal" data-bs-target="#bookModal">Book Now</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BOOK NOW MODAL -->
  <div class="modal fade" id="bookModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="/bookings/create/<%= listing._id %>">
        <div class="modal-content rounded-4 shadow-lg">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-bold">Book Your Stay</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label class="form-label fw-semibold">Select Dates</label>
            <input type="text" id="dateRange" class="form-control mb-3" required autocomplete="off" placeholder="Select a date range">
            <input type="hidden" name="startDate" id="startDate">
            <input type="hidden" name="endDate" id="endDate">

            <% if (listing.bookedDates?.length > 0) { %>
              <div class="text-danger small">
                <strong>Unavailable Dates:</strong>
                <%= listing.bookedDates.map(d => new Date(d).toLocaleDateString()).join(", ") %>
              </div>
            <% } %>
          </div>
          <div class="modal-footer border-0">
            <button type="submit" class="btn btn-danger w-100">Confirm Booking</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- REVIEWS -->
  <!-- REVIEWS -->
<div class="row mt-5">
  <div class="col-lg-8 offset-lg-2">
    <hr>
    <h4 class="fw-semibold mb-3">Reviews</h4>
    <% if (listing.reviews?.length > 0) { %>
      <% listing.reviews.forEach(review => { %>
        <div class="card rounded-4 shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <img src="<%= review.author?.avatar || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %>"
                   alt="Profile"
                   class="rounded-circle me-3"
                   style="width:50px; height:50px; object-fit:cover;">
              <div>
                <span class="fw-bold"><%= review.author?.username || 'Anonymous' %></span>
                <span class="ms-2 text-warning">
                  <% for(let i=1;i<=5;i++){ %>
                    <% if(i<=review.rating){ %>
                      <i class="fas fa-star"></i>
                    <% } else { %>
                      <i class="far fa-star"></i>
                    <% } %>
                  <% } %>
                  <span class="ms-2 text-muted">(<%= review.rating %>/5)</span>
                </span>
              </div>
              <small class="text-muted ms-auto"><%= new Date(review.createdAt).toLocaleDateString() %></small>
            </div>
            <p class="text-secondary mb-2"><%= review.comment %></p>
            <% if(currUser && review.author?._id && review.author._id.equals(currUser._id)) { %>
              <form method="POST" action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE" class="d-inline">
                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
              </form>
            <% } %>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <p class="text-muted">No reviews yet.</p>
    <% } %>
  </div>
</div>

<!-- LEAVE REVIEW -->
<div class="row mt-4">
  <div class="col-lg-8 offset-lg-2">
    <% if(currUser) { %>
      <hr>
      <h4 class="fw-semibold mb-3">Leave a Review</h4>
      <form id="reviewForm" action="/listings/<%=listing._id%>/reviews" method="POST" novalidate>
        <div class="mb-3">
          <label class="form-label fw-semibold">Rating</label>
          <div class="star-rating d-flex flex-row-reverse justify-content-end gap-2">
            <!-- Static star inputs (no EJS loop) -->
            <input type="radio" name="review[rating]" value="5" id="star5" required>
            <label for="star5" class="star" style="font-size:25px; cursor:pointer;">★</label>

            <input type="radio" name="review[rating]" value="4" id="star4">
            <label for="star4" class="star" style="font-size:25px; cursor:pointer;">★</label>

            <input type="radio" name="review[rating]" value="3" id="star3">
            <label for="star3" class="star" style="font-size:25px; cursor:pointer;">★</label>

            <input type="radio" name="review[rating]" value="2" id="star2">
            <label for="star2" class="star" style="font-size:25px; cursor:pointer;">★</label>

            <input type="radio" name="review[rating]" value="1" id="star1">
            <label for="star1" class="star" style="font-size:25px; cursor:pointer;">★</label>
          </div>
          <div id="rating-error" class="text-danger small" style="display:none;">Please select a rating</div>
        </div>
        <div class="mb-3">
          <label for="comment" class="form-label fw-semibold">Comments</label>
          <textarea class="form-control" name="review[comment]" id="comment" rows="4" required></textarea>
          <div class="invalid-feedback">Please enter your comment</div>
        </div>
        <button type="submit" class="btn btn-outline-dark w-100">Submit Review</button>
      </form>
    <% } else { %>
      <div class="text-center p-4 bg-light rounded-4 shadow-sm border">
        <h5 class="fw-semibold mb-2">Want to share your experience?</h5>
        <p class="text-muted mb-3">Please <a href="/login" class="text-danger fw-semibold">log in</a> to leave a review.</p>
        <a href="/login" class="btn btn-danger w-50">Login</a>
      </div>
    <% } %>
  </div>
</div>


  <!-- MAP -->
  <div class="row mt-5">
    <div class="col-lg-10 offset-lg-1">
      <hr>
      <h4 class="fw-semibold mb-3">Where you'll be</h4>
      <div id="map" style="height:500px; border-radius:24px; overflow:hidden; box-shadow:0 4px 32px rgba(0,0,0,0.12);"></div>
    </div>
  </div>
</div>

<!-- FLATPICKR -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Booking datepicker
  const bookedDates = <%- JSON.stringify(listing.bookedDates?.map(d=>new Date(d).toISOString().split("T")[0]) || []) %>;
  flatpickr("#dateRange", {
    mode: "range",
    minDate: "today",
    dateFormat: "Y-m-d",
    disable: bookedDates,
    onChange: function(selectedDates){
      if(selectedDates.length===2){
        document.getElementById("startDate").value = selectedDates[0].toISOString().split("T")[0];
        document.getElementById("endDate").value = selectedDates[1].toISOString().split("T")[0];
      }
    }
  });

  // Review validation
  const reviewForm = document.getElementById('reviewForm');
  if(reviewForm){
    const ratingError = document.getElementById('rating-error');
    reviewForm.addEventListener('submit', function(e){
      const selectedRating = document.querySelector('input[name="review[rating]"]:checked');
      if(!selectedRating){
        ratingError.style.display='block';
        e.preventDefault(); e.stopPropagation();
      } else ratingError.style.display='none';
      reviewForm.classList.add('was-validated');
    });
  }

  // MAP
  const apiKey = "<%= MAPTILER_API_KEY %>";
  if(typeof maplibregl !== 'undefined' && apiKey){
    let center = [78.9629, 20.5937]; // default India
    <% if(listing.geometry?.coordinates?.length===2){ %>
      center = [<%= listing.geometry.coordinates[0] %>, <%= listing.geometry.coordinates[1] %>];
    <% } %>
    const map = new maplibregl.Map({
      container: 'map',
      style: `https://api.maptiler.com/maps/streets/style.json?key=${apiKey}`,
      center,
      zoom: 12
    });
    map.addControl(new maplibregl.NavigationControl());
    new maplibregl.Marker().setLngLat(center).addTo(map);
  }
});
</script>
