<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= listing.title %> · Roamly</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">

  <style>
    :root {
      --red:#e54d42;
      --dark:#111315;
      --border:#e6e7eb;
      --radius:16px;
    }

    body { font-family:'Inter',sans-serif; background:#fff; color:#111; }
    .page-container { max-width:1200px; margin:auto; padding:20px; }

    .listing-title { font-size:2.4rem; font-weight:700; }
    .btn-book { background:var(--red); border:none; padding:10px 24px; border-radius:10px; color:#fff; font-weight:600; }
    .btn-book:hover { background:#cc3e35; }

    .gallery { aspect-ratio:16/9; overflow:hidden; border-radius:var(--radius); margin:18px 0; }
    .gallery img { width:100%; height:100%; object-fit:cover; }

    .cardish { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:22px; margin-bottom:20px; }

    .stars i { color:#f5b301; }

    /* Review star selector */
    .star-input input { display:none; }
    .star-input label { font-size:26px; color:#ccc; cursor:pointer; transition:0.2s; }
    .star-input input:checked ~ label { color:#f5b301; }
    .star-input label:hover,
    .star-input label:hover ~ label { color:#f5b301; }

    #map { margin-top:10px; width:100%; height:330px; border-radius:var(--radius); border:1px solid var(--border); }
  </style>
</head>
<body>

<div class="page-container">

  <!-- Title & Book Now -->
  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:14px;">
    <h1 class="listing-title"><%= listing.title %></h1>

    <button class="btn-book" data-bs-toggle="modal" data-bs-target="#bookModal">
      <i class="fa-regular fa-calendar-days"></i> Book Now
    </button>
  </div>

  <div class="listing-location text-muted">
    <i class="fa-solid fa-location-dot"></i> <%= listing.location %>, <%= listing.country %>
  </div>

  <div class="gallery">
    <img src="<%= listing.image?.url || 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=1600' %>">
  </div>

  <div class="cardish">
    <div style="display:flex; gap:12px; align-items:center;">
      <img src="<%= listing.owner?.avatar %>" style="width:60px;height:60px;border-radius:50%;object-fit:cover;">
      <strong>Hosted by <%= listing.owner?.username %></strong>
    </div>
    <hr>
    <p><%= listing.description %></p>
  </div>

  <h2>Reviews</h2>

  <% if(listing.reviews.length > 0){ %>
    <% listing.reviews.forEach(r => { %>
      <div class="cardish">
        <strong><%= r.author.username %></strong>
        <div class="stars">
          <% for(let i=1;i<=5;i++){ %>
            <i class="fa-solid fa-star" style="opacity:<%= i <= r.rating ? 1 : 0.3 %>"></i>
          <% } %>
        </div>
        <p><%= r.comment %></p>
      </div>
    <% }) %>
  <% } else { %>
    <p class="text-muted">No reviews yet. Be the first.</p>
  <% } %>

  <% if(currUser){ %>
  <div class="cardish">
    <h3>Leave a Review</h3>

    <form method="POST" action="/listings/<%= listing._id %>/reviews">

      <div class="star-input mb-2">
        <% for(let i=5;i>=1;i--){ %>
          <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>" required>
          <label for="star<%= i %>">★</label>
        <% } %>
      </div>

      <textarea name="review[comment]" class="form-control" placeholder="Share your experience..." required></textarea>
      <button class="btn btn-dark mt-2">Submit Review</button>
    </form>
  </div>
  <% } %>

  <h2>Where you'll be</h2>
  <div id="map"></div>

</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="/bookings/create/<%= listing._id %>">
        <div class="modal-header"><h5>Book Your Stay</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input id="dateRange" class="form-control" placeholder="Select dates" required>
          <input type="hidden" name="startDate" id="startDate">
          <input type="hidden" name="endDate" id="endDate">
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn-book">Confirm Booking</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<script>
  const bookedDates = <%- JSON.stringify(activeBookedDates) %> || [];

  flatpickr("#dateRange", {
    mode:"range", minDate:"today", dateFormat:"Y-m-d", disable:bookedDates,
    onChange:(sel)=>{ if(sel.length===2){ startDate.value=sel[0].toISOString().split("T")[0]; endDate.value=sel[1].toISOString().split("T")[0]; } }
  });

  const map = new maplibregl.Map({
    container:"map",
    style:`https://api.maptiler.com/maps/streets/style.json?key=<%= MAPTILER_API_KEY %>`,
    center:[<%= listing.geometry.coordinates[0] %>, <%= listing.geometry.coordinates[1] %>],
    zoom:12
  });
  new maplibregl.Marker().setLngLat([<%= listing.geometry.coordinates[0] %>, <%= listing.geometry.coordinates[1] %>]).addTo(map);
</script>

</body>
</html>

