<% layout("/layouts/boilerplate") %>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  :root{
    --roamly-red:#E54D42;
    --roamly-red-rgb:229,77,66;
    --roamly-dark:#1f1f1f;
    --roamly-text:#2b2b2b;
    --roamly-text-medium:#6b6b6b;
    --roamly-border:#e6e6e6;
    --roamly-bg:#ffffff;
    --roamly-bg-soft:#fafafa;
    --radius:14px;
    --shadow-1:0 2px 8px rgba(0,0,0,.06);
    --focus:0 0 0 3px rgba(var(--roamly-red-rgb), .2);
  }

  *{box-sizing:border-box}
  body{font-family:'Inter',sans-serif;background:var(--roamly-bg);color:var(--roamly-text);line-height:1.6;}

  a{color:var(--roamly-red);text-decoration:none}
  a:hover{text-decoration:underline}

  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
    padding:12px 18px;border-radius:12px;font-weight:600;cursor:pointer;transition:.2s;
    border:1px solid transparent;
  }
  .btn-danger{background:var(--roamly-red);color:#fff;}
  .btn-danger:hover{filter:brightness(.93);}
  .btn-dark{background:var(--roamly-dark);color:#fff;}
  .btn-outline{border:1px solid var(--roamly-red);color:var(--roamly-red);}
  .btn-outline:hover{background:var(--roamly-red);color:#fff;}

  .page-container{max-width:1160px;margin:32px auto;padding:0 20px}

  .listing-header-main h1{font-size:2.4rem;font-weight:800;margin-bottom:6px;}
  .listing-location{display:flex;align-items:center;gap:8px;color:var(--roamly-text-medium);font-weight:600}

  .listing-image-container{border-radius:18px;overflow:hidden;margin:18px 0 28px;box-shadow:var(--shadow-1);}
  .listing-image-container img{width:100%;object-fit:cover;display:block;max-height:520px;}

  .listing-body-grid{display:grid;grid-template-columns:1fr;gap:32px;}
  @media(min-width:992px){.listing-body-grid{grid-template-columns:2fr 1fr;}}

  .owner-info{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
  .owner-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;}
  .owner-name{font-weight:700;}

  /* NEW BOOK BUTTON INLINE */
  .top-book-btn{
    display:flex;align-items:center;gap:14px;
    background:var(--roamly-bg-soft);padding:14px 18px;border-radius:16px;
    border:1px solid var(--roamly-border);box-shadow:var(--shadow-1);
    margin:18px 0 26px;
  }
  .booking-price-inline{font-size:1.25rem;font-weight:700;color:var(--roamly-dark);}
  .booking-price-inline span{font-size:.9rem;color:var(--roamly-text-medium);}

  .listing-description{font-size:1.05rem;margin-bottom:12px;}

  .section-heading{font-size:1.5rem;font-weight:800;margin-bottom:16px;}

  /* REVIEWS */
  .review-list{display:flex;flex-direction:column;gap:16px;}
  .review-card{border:1px solid var(--roamly-border);padding:18px;border-radius:16px;box-shadow:var(--shadow-1);}
  .review-header{display:flex;align-items:center;gap:12px;margin-bottom:6px;}
  .author-avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;} /* FIXED SIZE */
  .author-name{font-weight:600;}
  .review-rating{color:#f7b500;}
  .review-comment{color:var(--roamly-text);}
  .review-actions{text-align:right;margin-top:6px;}

  .btn-delete-review{font-size:.9rem;background:none;border:none;color:var(--roamly-text-medium);cursor:pointer;}
  .btn-delete-review:hover{color:var(--roamly-red);}

  /* REVIEW FORM */
  .review-form-box{padding:18px;background:var(--roamly-bg-soft);border-radius:16px;border:1px solid var(--roamly-border);}
  .form-input{width:100%;border:1px solid var(--roamly-border);border-radius:12px;padding:10px;}
  textarea.form-input{resize:vertical;min-height:120px;}
  .star-rating{display:flex;flex-direction:row-reverse;gap:6px;}
  .star-rating input{display:none;}
  .star-rating label{font-size:28px;color:#d6d6d6;cursor:pointer;}
  .star-rating input:checked ~ label,
  .star-rating label:hover,
  .star-rating label:hover ~ label{color:#f7b500;}

  /* MAP */
  .listing-map{height:360px;border-radius:16px;border:1px solid var(--roamly-border);}

</style>


<div class="page-container">

  <!-- Header -->
  <header class="listing-header-main">
    <h1><%= listing.title %></h1>
    <div class="listing-location">
      <i class="fa-solid fa-location-dot"></i>
      <%= listing.location %>, <%= listing.country %>
    </div>
  </header>

  <!-- Image -->
  <div class="listing-image-container">
    <img src="<%= listing.image?.url %>" alt="">
  </div>

  <main class="listing-body-grid">

    <div class="listing-content">

      <section>
        <div class="owner-info">
          <img src="<%= listing.owner?.avatar %>" class="owner-avatar">
          <span class="owner-name">Hosted by <%= listing.owner?.username %></span>
        </div>

        <p class="listing-description"><%= listing.description %></p>

        <!-- ✅ BOOK BUTTON MOVED HERE -->
        <div class="top-book-btn">
          <div class="booking-price-inline">
            ₹<%= listing.price.toLocaleString("en-in") %> <span>/ night</span>
          </div>
          <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#bookModal">
            <i class="fa-regular fa-calendar"></i> Book Now
          </button>
        </div>

        <% if (currUser && listing.owner && listing.owner._id.equals(currUser._id)) { %>
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit</a>
        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
          <button class="btn btn-outline">Delete</button>
        </form>
        <% } %>

      </section>

      <hr>

      <!-- Reviews -->
      <h4 class="section-heading">Reviews</h4>
      <% if(listing.reviews.length > 0){ %>
      <div class="review-list">
        <% listing.reviews.forEach(r => { %>
        <div class="review-card">
          <div class="review-header">
            <img src="<%= r.author.avatar %>" class="author-avatar">
            <div>
              <div class="author-name"><%= r.author.username %></div>
              <div class="review-rating">
                <% for(let i=1;i<=5;i++){ %>
                  <%= i<=r.rating ? "★" : "☆" %>
                <% } %>
              </div>
            </div>
          </div>
          <p class="review-comment"><%= r.comment %></p>

          <% if(currUser && r.author._id.equals(currUser._id)){ %>
          <div class="review-actions">
            <form method="POST" action="/listings/<%=listing._id%>/reviews/<%=r._id%>?_method=DELETE">
              <button class="btn-delete-review">Delete</button>
            </form>
          </div>
          <% } %>
        </div>
        <% }) %>
      </div>
      <% } else { %>
      <p>No reviews yet.</p>
      <% } %>

      <hr>

      <!-- Leave Review -->
      <% if(currUser){ %>
      <div class="review-form-box">
        <form method="POST" action="/listings/<%= listing._id %>/reviews">
          <div class="star-rating">
            <input type="radio" name="review[rating]" value="5" id="star5"><label for="star5">★</label>
            <input type="radio" name="review[rating]" value="4" id="star4"><label for="star4">★</label>
            <input type="radio" name="review[rating]" value="3" id="star3"><label for="star3">★</label>
            <input type="radio" name="review[rating]" value="2" id="star2"><label for="star2">★</label>
            <input type="radio" name="review[rating]" value="1" id="star1"><label for="star1">★</label>
          </div>
          <textarea class="form-input" name="review[comment]" required></textarea>
          <button class="btn btn-dark" style="margin-top:10px;">Submit Review</button>
        </form>
      </div>
      <% } %>

      <hr>

      <h4 class="section-heading">Where you'll be</h4>
      <div id="map" class="listing-map"></div>

    </div>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  /* Calendar stays same */
</script>

