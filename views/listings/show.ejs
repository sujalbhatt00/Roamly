<% layout("/layouts/boilerplate") %>

<div class="container mt-4 mb-5">

  <!-- IMAGE + TITLE -->
  <div class="row">
    <div class="col-lg-10 offset-lg-1">
      <div class="rounded-4 overflow-hidden shadow-sm mb-4">
        <img src="<%= listing.image && listing.image.url ? listing.image.url : 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800&h=600&fit=crop' %>"
             alt="Listing Image"
             class="w-100"
             style="height:480px; object-fit:cover;"
             onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800&h=600&fit=crop';">
      </div>

      <div class="mt-4">
        <h1 class="fw-bold" style="font-size:2.4rem;"><%= listing.title %></h1>
        <div class="d-flex justify-content-between align-items-center flex-wrap mt-2">
          <div>
            <i class="fa-solid fa-location-dot text-danger me-1"></i>
            <span class="text-muted"><%= listing.location %>, <%= listing.country %></span>
          </div>
          <div class="fs-4 fw-semibold text-danger">₹<%= listing.price ? listing.price.toLocaleString("en-in") : "N/A" %> / night</div>
        </div>
      </div>
    </div>
  </div>

  <!-- OWNER + DESCRIPTION + ACTIONS -->
  <div class="row mt-4">
    <div class="col-lg-10 offset-lg-1">
      <div class="p-4 bg-white rounded-4 shadow-sm mb-4">
        <div class="d-flex align-items-center mb-3">
          <img src="<%= listing.owner && listing.owner.avatar ? listing.owner.avatar : 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %>"
               alt="Owner"
               class="rounded-circle me-3 shadow-sm"
               style="width:55px; height:55px; object-fit:cover;">
          <div>
            <p class="mb-0 fw-semibold">Hosted by <%= listing.owner ? listing.owner.username : 'sujalbhatt' %></p>
          </div>
        </div>

        <p class="text-muted lh-lg mb-4"><%= listing.description %></p>

        <div class="d-flex gap-3 flex-wrap">
          <% if (currUser && listing.owner && (listing.owner._id.equals(currUser._id) || currUser.username === 'sujalbhatt')) { %>
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark px-4">Edit</a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
              <button type="submit" class="btn btn-outline-danger px-4">Delete</button>
            </form>
          <% } %>
          <!-- Book Now Button -->
          

          <!-- Book Now Modal -->
<div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="/bookings/create/<%= listing._id %>">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bookModalLabel">Book Your Stay</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Select Date Range:</label>
          <input type="text" name="dateRange" id="dateRange" class="form-control" required autocomplete="off">
          <input type="hidden" name="startDate" id="startDate">
          <input type="hidden" name="endDate" id="endDate">

          <% if (listing.bookedDates && listing.bookedDates.length > 0) { %>
            <div class="mt-2 text-danger small">
              <strong>Unavailable Dates:</strong>
              <%= listing.bookedDates.map(d => new Date(d).toLocaleDateString()).join(", ") %>
            </div>
          <% } %>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Confirm Booking</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Flatpickr for Date Range -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const bookedDates = <%- JSON.stringify(listing.bookedDates ? listing.bookedDates.map(d => new Date(d).toISOString().split("T")[0]) : []) %>;

  flatpickr("#dateRange", {
    mode: "range",
    minDate: "today",
    dateFormat: "Y-m-d",
    disable: bookedDates,
    onChange: function(selectedDates) {
      if (selectedDates.length === 2) {
        document.getElementById("startDate").value = selectedDates[0].toISOString().split("T")[0];
        document.getElementById("endDate").value = selectedDates[1].toISOString().split("T")[0];
      }
    }
  });
});
</script>


  <!-- REVIEWS LIST -->
  <div class="row mt-5">
    <div class="col-lg-8 offset-lg-2">
      <hr>
      <h4 class="fw-semibold mb-3">Reviews</h4>
      <% if (listing.reviews && listing.reviews.length > 0) { %>
        <% for (let review of listing.reviews) { %>
          <div class="card border-0 shadow-sm mb-3 rounded-4">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <img src="<%= review.author && review.author.avatar ? review.author.avatar : 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %>"
                     alt="Profile Picture"
                     class="rounded-circle me-3"
                     style="width:50px; height:50px; object-fit:cover;">
                <div>
                  <span class="fw-bold"><%= review.author && review.author.username ? review.author.username : 'Anonymous' %></span>
                  <span class="ms-2 text-warning">
                    <% for (let i = 1; i <= 5; i++) { %>
                      <% if (i <= review.rating) { %>
                        <i class="fas fa-star"></i>
                      <% } else { %>
                        <i class="far fa-star"></i>
                      <% } %>
                    <% } %>
                    <span class="ms-2 text-muted">(<%= review.rating %>/5)</span>
                  </span>
                </div>
                <small class="text-muted ms-auto"><%= new Date(review.createdAt).toLocaleDateString() %></small>
              </div>
              <p class="text-secondary mb-2"><%= review.comment %></p>
              <% if(currUser && review.author && review.author._id && review.author._id.equals(currUser._id)) { %>
                <form method="POST" action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this review?')">Delete Review</button>
                </form>
              <% } %>
            </div>
          </div>
        <% } %>
      <% } else { %>
        <p class="text-muted">No reviews yet. Be the first to leave one!</p>
      <% } %>
    </div>
  </div>

  <!-- REVIEW FORM / LOGIN NOTICE -->
  <div class="row mt-5">
    <div class="col-lg-8 offset-lg-2">
      <% if(currUser) { %>
        <hr>
        <h4 class="fw-semibold mb-3">Leave a Review</h4>
        <form id="reviewForm" action="/listings/<%=listing._id %>/reviews" method="post" novalidate>
          <div class="mb-3">
            <label class="form-label">Rating</label>
            <div class="star-rating">
              <% for(let i = 5; i >= 1; i--) { %>
                <input type="radio" name="review[rating]" value="<%= i %>" id="star<%= i %>" required>
                <label for="star<%= i %>" class="star">★</label>
              <% } %>
            </div>
            <div id="rating-error" class="text-danger" style="display:none;">Please select a rating</div>
          </div>
          <div class="mb-3">
            <label for="comment" class="form-label">Comments</label>
            <textarea class="form-control" name="review[comment]" id="comment" rows="4" required></textarea>
            <div class="invalid-feedback">Please enter your comments</div>
          </div>
          <button type="submit" class="btn btn-outline-dark px-4">Submit Review</button>
        </form>
      <% } else { %>
        <div class="text-center p-5 bg-light rounded-4 border mt-3 shadow-sm">
          <h5 class="fw-semibold mb-3">Want to share your experience?</h5>
          <p class="text-muted mb-4">Please <a href="/login" class="text-danger fw-semibold">log in</a> to leave a review.</p>
          <a href="/login" class="btn btn-danger px-4">Login to Review</a>
        </div>
      <% } %>
    </div>
  </div>

  <!-- MAP AT THE END -->
  <div class="row mt-5">
    <div class="col-lg-10 offset-lg-1">
      <hr>
      <h4 class="fw-semibold mb-3">Where you'll be</h4>
      <div id="map" style="height:700px; border-radius:24px; overflow:hidden; box-shadow:0 4px 32px rgba(0,0,0,0.12);"></div>
    </div>
  </div>
</div>

<!-- STAR RATING STYLE -->
<style>
.star-rating {
  display: flex;
  flex-direction: row-reverse;
  justify-content: flex-end;
  gap: 5px;
}
.star-rating input[type="radio"] { display: none; }
.star-rating label {
  cursor: pointer;
  font-size: 30px;
  color: #ddd;
  transition: color 0.3s;
}
.star-rating input[type="radio"]:checked ~ label { color: #ffc107; }
.star-rating label:hover, .star-rating label:hover ~ label { color: #ffc107; }
</style>

<!-- REVIEW VALIDATION -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('reviewForm');
  if (!form) return;

  const ratingError = document.getElementById('rating-error');

  form.addEventListener('submit', function(event) {
    let isValid = form.checkValidity();
    const selectedRating = document.querySelector('input[name="review[rating]"]:checked');

    if (!selectedRating) {
      ratingError.style.display = 'block';
      isValid = false;
    } else {
      ratingError.style.display = 'none';
    }

    if (!isValid) {
      event.preventDefault();
      event.stopPropagation();
    }

    form.classList.add('was-validated');
  }, false);
});
</script>

<!-- MAP SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const apiKey = "<%= MAPTILER_API_KEY %>";
  if (typeof maplibregl === 'undefined' || !apiKey) return;

  let center = [78.9629, 20.5937];
  <% if (listing.geometry && listing.geometry.coordinates && listing.geometry.coordinates[0] !== 0 && listing.geometry.coordinates[1] !== 0) { %>
    center = [<%= listing.geometry.coordinates[0] %>, <%= listing.geometry.coordinates[1] %>];
  <% } %>

  const map = new maplibregl.Map({
    container: 'map',
    style: `https://api.maptiler.com/maps/streets/style.json?key=${apiKey}`,
    center,
    zoom: 12
  });

  map.addControl(new maplibregl.NavigationControl());
  new maplibregl.Marker().setLngLat(center).addTo(map);
});
</script>