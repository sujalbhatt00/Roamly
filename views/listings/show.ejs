<% layout("/layouts/boilerplate") %>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  /* ------------------------------
     Roamly Design System (Clean)
  ------------------------------- */
  :root{
    --roamly-red:#E54D42;
    --roamly-red-rgb:229,77,66;
    --roamly-dark:#1f1f1f;
    --roamly-text:#2b2b2b;
    --roamly-text-medium:#6b6b6b;
    --roamly-border:#e6e6e6;
    --roamly-bg:#ffffff;
    --roamly-bg-soft:#fafafa;

    --radius-sm:10px;
    --radius:14px;
    --shadow-1:0 2px 8px rgba(0,0,0,.06);
    --shadow-2:0 10px 30px rgba(0,0,0,.10);

    --focus:0 0 0 3px rgba(var(--roamly-red-rgb), .2);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--roamly-bg);
    color:var(--roamly-text);
    line-height:1.6;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  a{color:var(--roamly-red);text-decoration:none}
  a:hover{text-decoration:underline}
  p{color:var(--roamly-text-medium)}
  hr{border:0;border-top:1px solid var(--roamly-border);margin:28px 0}

  /* ------------------------------
     Buttons
  ------------------------------- */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
    border:1px solid transparent;
    background:#fff;color:var(--roamly-dark);
    padding:12px 18px;border-radius:12px;font-weight:600;cursor:pointer;
    transition:transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease, color .2s ease;
    text-align:center;user-select:none;
  }
  .btn:active{transform:translateY(1px)}
  .btn:focus-visible{outline:none;box-shadow:var(--focus)}
  .btn-dark{background:var(--roamly-dark);color:#fff;border-color:var(--roamly-dark)}
  .btn-dark:hover{filter:brightness(.92)}
  .btn-danger{background:var(--roamly-red);color:#fff;border-color:var(--roamly-red)}
  .btn-danger:hover{filter:brightness(.95)}
  .btn-outline{
    background:#fff;border-color:var(--roamly-red);color:var(--roamly-red)
  }
  .btn-outline:hover{background:var(--roamly-red);color:#fff}

  /* ------------------------------
     Layout
  ------------------------------- */
  .page-container{max-width:1160px;margin:32px auto;padding:0 20px}
  .listing-header-main{margin-bottom:18px}
  .listing-header-main h1{
    font-size:clamp(1.6rem,2.4vw,2.5rem);
    font-weight:800;margin:0 0 6px;color:var(--roamly-dark);letter-spacing:-.02em;
  }
  .listing-location{
    display:flex;align-items:center;gap:8px;
    color:var(--roamly-text-medium);font-weight:600
  }

  /* Hero image */
  .listing-image-container{
    width:100%;max-height:520px;overflow:hidden;
    border-radius:18px;margin:18px 0 28px;box-shadow:var(--shadow-1);background:#f2f2f2;
  }
  .listing-image-container img{width:100%;height:100%;object-fit:cover;display:block}

  /* Grid */
  .listing-body-grid{display:grid;grid-template-columns:1fr;gap:28px}
  @media (min-width:992px){
    .listing-body-grid{grid-template-columns:2fr 1fr;gap:44px}
  }

  /* Info */
  .info-section{padding:0}
  .owner-info{display:flex;align-items:center;gap:12px}
  .owner-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
  .owner-name{font-weight:700;color:var(--roamly-dark)}
  .listing-description{font-size:1.05rem;color:var(--roamly-text);margin:14px 0 8px}

  .listing-actions{display:flex;flex-wrap:wrap;gap:10px}
  .listing-actions form{display:contents}

  /* Booking Card */
  .listing-sidebar{position:relative}
  @media (min-width:992px){
    .listing-sidebar{position:sticky;top:108px;height:fit-content}
  }
  .booking-card{
    border:1px solid var(--roamly-border);
    border-radius:18px;background:#fff;padding:22px;
    box-shadow:var(--shadow-2)
  }
  .booking-price{font-size:1.6rem;font-weight:800;color:var(--roamly-dark)}
  .booking-price span{font-size:1rem;font-weight:500;color:var(--roamly-text-medium}
  .price-helper{font-size:.95rem;color:var(--roamly-text-medium);margin-top:6px}

  /* Sections */
  .section-heading{
    font-size:clamp(1.2rem,2vw,1.6rem);font-weight:800;margin:0 0 16px;color:var(--roamly-dark);
  }

  /* Reviews */
  .review-list{display:flex;flex-direction:column;gap:16px}
  .review-card{
    border:1px solid var(--roamly-border);border-radius:16px;padding:18px;background:#fff;box-shadow:var(--shadow-1)
  }
  .review-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .author-avatar{width:46px;height:46px;border-radius:50%;object-fit:cover}
  .author-info{flex:1}
  .author-name{font-weight:700}
  .review-rating{color:#f7b500;font-size:.95rem}
  .review-date{font-size:.9rem;color:var(--roamly-text-medium)}
  .review-comment{margin:.25rem 0 0}
  .review-actions{text-align:right;margin-top:8px}
  .btn-delete-review{
    display:inline-flex;align-items:center;gap:.45em;
    background:transparent;border:1px dashed transparent;color:var(--roamly-text-medium);
    padding:6px 10px;border-radius:10px;font-weight:600;cursor:pointer;
    transition:all .2s ease;
  }
  .btn-delete-review:hover{background:rgba(var(--roamly-red-rgb),.08);color:var(--roamly-red);border-color:rgba(var(--roamly-red-rgb),.3)}
  .btn-delete-review:focus-visible{outline:none;box-shadow:var(--focus)}

  /* Review form */
  .review-form-box{
    border:1px solid var(--roamly-border);border-radius:16px;background:var(--roamly-bg-soft);
    padding:18px;
  }
  .form-group{margin-bottom:14px}
  .form-label{display:block;font-weight:700;margin-bottom:.5rem}
  .form-input{
    width:100%;padding:11px 12px;border:1px solid var(--roamly-border);border-radius:12px;font-size:1rem;
    font-family:inherit;background:#fff;transition:border-color .2s, box-shadow .2s;
  }
  .form-input:focus{outline:none;border-color:var(--roamly-red);box-shadow:var(--focus)}
  textarea.form-input{resize:vertical;min-height:120px}
  .invalid-feedback{display:none;color:var(--roamly-red);font-size:.9rem;margin-top:6px}
  .is-invalid + .invalid-feedback{display:block}

  /* Better star rating (keyboard accessible) */
  .star-rating{display:inline-flex;flex-direction:row-reverse;gap:6px}
  .star-rating input{position:absolute;opacity:0;pointer-events:none}
  .star-rating label{
    font-size:28px;line-height:1;color:#d6d6d6;cursor:pointer;transition:transform .1s ease,color .15s ease;
  }
  .star-rating label:hover{transform:scale(1.1)}
  .star-rating input:focus + label{outline:none;text-shadow:0 0 0 3px rgba(0,0,0,0)}
  .star-rating input:checked ~ label,
  .star-rating label:hover,
  .star-rating label:hover ~ label{color:#f7b500}
  .rating-error-message{display:none;color:var(--roamly-red);font-size:.9rem;margin-top:8px}

  /* Map */
  .listing-map{height:360px;width:100%;border-radius:16px;overflow:hidden;border:1px solid var(--roamly-border);background:#f2f2f2}

  /* Modal (bootstrap overrides) */
  .modal-content{border-radius:16px;border:none}
  .modal-header{border-bottom:1px solid var(--roamly-border)}
  .modal-footer{border-top:1px solid var(--roamly-border);background:var(--roamly-bg-soft)}
  #bookModal .form-label{font-weight:700;margin-bottom:.5rem}

  /* ------------------------------
     Flatpickr – Airbnb-like skin
  ------------------------------- */
  .flatpickr-calendar{z-index:1056;border:1px solid var(--roamly-border);border-radius:14px;box-shadow:var(--shadow-2)}
  .flatpickr-months .flatpickr-month{height:48px}
  .flatpickr-current-month input.cur-year{font-weight:700}
  .flatpickr-day{
    border-radius:10px;line-height:36px;margin:3px;
  }
  .flatpickr-day:hover{background:rgba(var(--roamly-red-rgb),.1)}
  .flatpickr-day.selected,
  .flatpickr-day.startRange,
  .flatpickr-day.endRange{
    background:var(--roamly-red);border-color:var(--roamly-red);color:#fff;
  }
  .flatpickr-day.inRange{background:rgba(var(--roamly-red-rgb),.12);border-color:transparent}
  .flatpickr-day.flatpickr-disabled,
  .flatpickr-day.disabled{color:#c9c9c9}
  .flatpickr-weekday{font-weight:700}

  .unavailable-dates-info{
    font-size:.92rem;color:var(--roamly-text-medium);
    margin-top:.5rem;padding:.75rem;border-radius:12px;border:1px dashed var(--roamly-border);background:#fff
  }
  .unavailable-dates-info strong{color:var(--roamly-dark)}

  /* Small screens */
  @media (max-width:600px){
    .listing-image-container{max-height:300px}
    .listing-map{height:260px}
    .booking-card{padding:16px}
    .review-form-box{padding:14px}
  }
</style>

<div class="page-container">

  <!-- Header -->
  <header class="listing-header-main">
    <h1><%= listing.title %></h1>
    <div class="listing-location" aria-label="Listing location">
      <i class="fa-solid fa-location-dot" aria-hidden="true"></i>
      <span><%= listing.location %>, <%= listing.country %></span>
    </div>
  </header>

  <!-- Hero image -->
  <div class="listing-image-container" aria-label="Listing image">
    <img
      src="<%= listing.image?.url || 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=1600&h=900&fit=crop' %>"
      alt="Listing Image"
      loading="lazy"
      onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=1600&h=900&fit=crop';">
  </div>

  <main class="listing-body-grid">
    <!-- Left -->
    <div class="listing-content">
      <section class="info-section">
        <div class="owner-info">
          <img src="<%= listing.owner?.avatar || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %>"
               alt="Host avatar" class="owner-avatar" loading="lazy">
          <span class="owner-name">Hosted by <%= listing.owner?.username || 'Host' %></span>
        </div>

        <p class="listing-description"><%= listing.description %></p>

        <div class="listing-actions">
          <% if (currUser && listing.owner && (listing.owner._id.equals(currUser._id) || currUser.username === 'sujalbhatt')) { %>
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark" aria-label="Edit listing">
              <i class="fa-regular fa-pen-to-square"></i> Edit
            </a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE"
                  onsubmit="return confirm('Are you sure you want to delete this listing?');">
              <button type="submit" class="btn btn-outline" aria-label="Delete listing">
                <i class="fa-regular fa-trash-can"></i> Delete
              </button>
            </form>
          <% } %>
        </div>
      </section>

      <hr>

      <!-- Reviews -->
      <section class="review-section" id="reviews">
        <h4 class="section-heading">Reviews</h4>
        <% if (listing.reviews?.length > 0) { %>
          <div class="review-list">
            <% listing.reviews.forEach(review => { %>
              <div class="review-card">
                <div class="review-header">
                  <img src="<%= review.author?.avatar || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %>"
                       alt="Reviewer avatar" class="author-avatar" loading="lazy">
                  <div class="author-info">
                    <span class="author-name"><%= review.author?.username || 'Anonymous' %></span>
                    <span class="review-rating" aria-label="Rating">
                      <% for(let i=1;i<=5;i++){ %>
                        <% if(i<=review.rating){ %><i class="fas fa-star" aria-hidden="true"></i>
                        <% } else { %><i class="far fa-star" aria-hidden="true"></i><% } %>
                      <% } %>
                    </span>
                  </div>
                  <small class="review-date"><%= new Date(review.createdAt).toLocaleDateString() %></small>
                </div>
                <p class="review-comment"><%= review.comment %></p>

                <% if(currUser && review.author?._id && review.author._id.equals(currUser._id)) { %>
                  <div class="review-actions">
                    <form method="POST" action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE"
                          onsubmit="return confirm('Delete this review?');">
                      <button type="submit" class="btn-delete-review">
                        <i class="fa-regular fa-trash-can"></i> Delete
                      </button>
                    </form>
                  </div>
                <% } %>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <p>No reviews yet.</p>
        <% } %>
      </section>

      <hr>

      <!-- Leave a review -->
      <section class="leave-review-section">
        <% if(currUser) { %>
          <div class="review-form-box">
            <h4 class="section-heading" style="margin-bottom:8px;">Leave a Review</h4>

            <form id="reviewForm" action="/listings/<%=listing._id%>/reviews" method="POST" novalidate class="needs-validation" autocomplete="off">
              <div class="form-group">
                <label class="form-label">Rating</label>
                <div class="star-rating" role="radiogroup" aria-label="Rating">
                  <input type="radio" name="review[rating]" value="5" id="star5" required><label for="star5" title="5 stars">★</label>
                  <input type="radio" name="review[rating]" value="4" id="star4"><label for="star4" title="4 stars">★</label>
                  <input type="radio" name="review[rating]" value="3" id="star3"><label for="star3" title="3 stars">★</label>
                  <input type="radio" name="review[rating]" value="2" id="star2"><label for="star2" title="2 stars">★</label>
                  <input type="radio" name="review[rating]" value="1" id="star1"><label for="star1" title="1 star">★</label>
                </div>
                <div id="rating-error" class="rating-error-message">Please select a rating.</div>
              </div>

              <div class="form-group">
                <label for="comment" class="form-label">Comments</label>
                <textarea class="form-input" name="review[comment]" id="comment" rows="4" required></textarea>
                <div class="invalid-feedback">Please enter your comment.</div>
              </div>

              <button type="submit" class="btn btn-dark">Submit Review</button>
            </form>
          </div>
        <% } else { %>
          <div class="review-form-box" role="region" aria-label="Login to review">
            <h5 style="margin:0 0 .25rem;font-weight:800">Want to share your experience?</h5>
            <p style="margin:.25rem 0 1rem">Please <a href="/login?returnTo=/listings/<%= listing._id %>">log in</a> to leave a review.</p>
            <a href="/login?returnTo=/listings/<%= listing._id %>" class="btn btn-danger">Login</a>
          </div>
        <% } %>
      </section>

      <hr>

      <!-- Map -->
      <section class="map-section">
        <h4 class="section-heading">Where you'll be</h4>
        <div id="map" class="listing-map" aria-label="Map of listing location"></div>
      </section>
    </div>

    <!-- Sidebar -->
    <aside class="listing-sidebar">
      <div class="booking-card" aria-live="polite">
        <div class="booking-price">
          ₹<%= listing.price ? listing.price.toLocaleString("en-in") : "N/A" %> <span>/ night</span>
        </div>
        <div class="price-helper" id="priceSummary" hidden>
          <span id="nightsText"></span> • <strong id="totalText"></strong>
        </div>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#bookModal">
          <i class="fa-regular fa-calendar"></i> Book Now
        </button>
      </div>
    </aside>
  </main>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="/bookings/create/<%= listing._id %>" id="bookingForm" class="needs-validation" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="bookModalLabel">Book Your Stay</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <label for="dateRange" class="form-label">Select Dates</label>
          <input type="text" id="dateRange" class="form-input" required autocomplete="off" placeholder="Check-in → Check-out" aria-describedby="dateRangeFeedback">

          <input type="hidden" name="startDate" id="startDate" required>
          <input type="hidden" name="endDate" id="endDate" required>
          <div class="invalid-feedback" id="dateRangeFeedback">Please select a valid date range.</div>

          <% if (listing.bookedDates?.length > 0) {
              const formattedBookedDates = listing.bookedDates.map(d => new Date(d).toLocaleDateString('en-CA')); // YYYY-MM-DD
          %>
            <div class="unavailable-dates-info">
              <strong>Currently Unavailable:</strong><br>
              <%
                 let ranges = [];
                 if (formattedBookedDates.length > 0) {
                   formattedBookedDates.sort();
                   let startRange = formattedBookedDates[0];
                   let endRange = formattedBookedDates[0];
                   for (let i = 1; i < formattedBookedDates.length; i++) {
                     const currentDate = new Date(formattedBookedDates[i]);
                     const previousDate = new Date(endRange);
                     const nextDay = new Date(previousDate);
                     nextDay.setDate(previousDate.getDate() + 1);
                     if (currentDate.toISOString().split('T')[0] === nextDay.toISOString().split('T')[0]) {
                       endRange = formattedBookedDates[i];
                     } else {
                       ranges.push(startRange === endRange ? new Date(startRange).toLocaleDateString() : `${new Date(startRange).toLocaleDateString()} - ${new Date(endRange).toLocaleDateString()}`);
                       startRange = formattedBookedDates[i];
                       endRange = formattedBookedDates[i];
                     }
                   }
                   ranges.push(startRange === endRange ? new Date(startRange).toLocaleDateString() : `${new Date(startRange).toLocaleDateString()} - ${new Date(endRange).toLocaleDateString()}`);
                 }
              %>
              <%- ranges.join('<br>') %>
            </div>
          <% } %>

          <!-- Live price summary inside modal -->
          <div id="modalPrice" style="margin-top:10px;font-weight:600"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Confirm Booking</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // ------------------ Calendar + Pricing
  const pricePerNight = <%= Number.isFinite(listing.price) ? listing.price : 0 %>;
  const startDateInput = document.getElementById('startDate');
  const endDateInput   = document.getElementById('endDate');
  const dateRangeInput = document.getElementById('dateRange');
  const dateRangeFeedback = document.getElementById('dateRangeFeedback');
  const bookedDates = <%- JSON.stringify(activeBookedDates) %> || [];

  const priceSummary = document.getElementById('priceSummary');
  const nightsText = document.getElementById('nightsText');
  const totalText = document.getElementById('totalText');
  const modalPrice = document.getElementById('modalPrice');

  function formatINR(n){ return new Intl.NumberFormat('en-IN').format(n); }
  function dayDiff(a,b){ return Math.round((b - a) / (1000*60*60*24)); }

  function updatePriceUI(){
    if(!startDateInput.value || !endDateInput.value || !pricePerNight){ 
      priceSummary.hidden = true; modalPrice.textContent = ''; return; 
    }
    const n = dayDiff(new Date(startDateInput.value), new Date(endDateInput.value));
    const total = Math.max(0, n) * pricePerNight;
    nightsText.textContent = n ? (n === 1 ? '1 night' : n + ' nights') : '';
    totalText.textContent = '₹' + formatINR(total) + ' total';
    priceSummary.hidden = !n;
    modalPrice.textContent = n ? `${nightsText.textContent} • ₹${formatINR(pricePerNight)} / night → Total ₹${formatINR(total)}` : '';
  }

  // Create a Set of disabled date strings for fast check
  const disabledSet = new Set(bookedDates.map(d => new Date(d).toISOString().split('T')[0]));

  const fp = flatpickr('#dateRange', {
    mode:'range',
    minDate:'today',
    dateFormat:'Y-m-d',
    disable: bookedDates,
    weekNumbers: true,
    shorthandCurrentMonth: true,
    showMonths: window.matchMedia('(min-width: 600px)').matches ? 2 : 1, // 2 months on larger screens
    onChange(selectedDates, dateStr, instance){
      if(selectedDates.length === 2){
        const [start, end] = selectedDates;
        const s = start.toISOString().split('T')[0];
        const e = end.toISOString().split('T')[0];

        // Validate that the chosen range doesn't include a disabled date
        let valid = true;
        const cur = new Date(s);
        while(cur <= end){
          const key = cur.toISOString().split('T')[0];
          if(disabledSet.has(key)){ valid = false; break; }
          cur.setDate(cur.getDate()+1);
        }

        if(!valid){
          instance.clear();
          startDateInput.value = '';
          endDateInput.value = '';
          dateRangeInput.value = '';
          dateRangeInput.classList.add('is-invalid');
          dateRangeFeedback.textContent = 'Selected range includes unavailable dates.';
          dateRangeFeedback.style.display = 'block';
          updatePriceUI();
          return;
        }

        startDateInput.value = s;
        endDateInput.value = e;
        dateRangeInput.value = `${s} to ${e}`;
        dateRangeInput.classList.remove('is-invalid');
        dateRangeFeedback.style.display = 'none';
        updatePriceUI();
      } else {
        startDateInput.value = '';
        endDateInput.value = '';
        updatePriceUI();
      }
    },
  });

  // ------------------ Review Form Validation
  const reviewForm = document.getElementById('reviewForm');
  if(reviewForm){
    const ratingError = document.getElementById('rating-error');
    reviewForm.addEventListener('submit', function(event){
      const selected = reviewForm.querySelector('input[name="review[rating]"]:checked');
      if(!selected){ ratingError.style.display='block'; event.preventDefault(); event.stopPropagation(); }
      else{ ratingError.style.display='none'; }
      if(!reviewForm.checkValidity()){ event.preventDefault(); event.stopPropagation(); }
      reviewForm.classList.add('was-validated');
    }, false);
    // Keyboard: allow arrow keys to move rating
    const stars = Array.from(reviewForm.querySelectorAll('input[name="review[rating]"]'));
    stars.forEach((input, idx)=>{
      const label = reviewForm.querySelector('label[for="'+input.id+'"]');
      label.tabIndex = 0;
      label.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowLeft' || e.key === 'ArrowDown'){ e.preventDefault(); const nxt = Math.min(stars.length-1, idx+1); stars[nxt].checked = true; }
        if(e.key === 'ArrowRight' || e.key === 'ArrowUp'){ e.preventDefault(); const prv = Math.max(0, idx-1); stars[prv].checked = true; }
      });
    });
  }

  // ------------------ Booking Form Validation
  const bookingForm = document.getElementById('bookingForm');
  if(bookingForm){
    bookingForm.addEventListener('submit', function(event){
      if(!startDateInput.value || !endDateInput.value){
        dateRangeInput.classList.add('is-invalid');
        dateRangeFeedback.textContent = 'Please select both check-in and check-out dates.';
        dateRangeFeedback.style.display = 'block';
        event.preventDefault(); event.stopPropagation();
      } else {
        dateRangeInput.classList.remove('is-invalid');
        dateRangeFeedback.style.display = 'none';
      }
      if(!bookingForm.checkValidity()){ event.preventDefault(); event.stopPropagation(); }
      bookingForm.classList.add('was-validated');
    }, false);
  }

  // ------------------ MapLibre
  const apiKey = "<%= MAPTILER_API_KEY %>";
  if (typeof maplibregl !== 'undefined' && apiKey) {
    let center = [78.9629, 20.5937]; // Default India
    <% if(listing.geometry?.coordinates?.length === 2){ %>
      center = [<%= listing.geometry.coordinates[0] %>, <%= listing.geometry.coordinates[1] %>];
    <% } %>
    const map = new maplibregl.Map({
      container:'map',
      style:`https://api.maptiler.com/maps/streets/style.json?key=${apiKey}`,
      center:center,zoom:12
    });
    map.addControl(new maplibregl.NavigationControl());
    new maplibregl.Marker().setLngLat(center).addTo(map);
  }
});
</script>
