<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= listing.title %> · Roamly</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-8rj6jR5g3Qe4yXzS7n3qj4yoYx1nY0Q4d2sNfJYq0Xv3oXk0jU2XyTtWZ2s7e1rPj4lqg2+KJ5vGq5mP1lHRwQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Bootstrap (for modal & utilities) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

  <!-- MapLibre GL -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    /* ------------------------------
       Roamly Modern Design System
    ------------------------------ */
    :root {
      --roamly-red: #e54d42;
      --roamly-red-rgb: 229, 77, 66;
      --roamly-dark: #111315;
      --roamly-text: #2b2f33;
      --roamly-text-med: #636b74;
      --roamly-border: #e6e7eb;
      --roamly-muted: #f6f7f9;
      --radius-sm: 10px;
      --radius: 16px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 8px 24px rgba(16, 24, 40, 0.12);
    }

    html { scroll-behavior: smooth; }
    @media (prefers-reduced-motion: reduce) { html { scroll-behavior: auto; } }

    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--roamly-text);
      background: #fff;
      margin: 0;
    }

    a { color: var(--roamly-red); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .page-container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* ---------- Header ---------- */
    .listing-header {
      display: grid;
      gap: 10px;
      margin: 8px 0 18px;
    }
    .listing-title {
      font-size: clamp(1.5rem, 2.2vw + 1rem, 2.5rem);
      font-weight: 700;
      color: var(--roamly-dark);
      line-height: 1.2;
    }
    .listing-location { display: inline-flex; align-items: center; gap: 8px; color: var(--roamly-text-med); font-weight: 500; }
    .listing-location i { font-size: 1rem; }

    /* ---------- Gallery ---------- */
    .gallery {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      background: #eef1f4;
    }
    .gallery img { width: 100%; height: 100%; object-fit: cover; display: block; }

    /* ---------- Layout ---------- */
    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      margin-top: 20px;
    }
    @media (min-width: 992px) {
      .layout { grid-template-columns: 2fr 1fr; gap: 40px; }
      .sidebar { position: sticky; top: 96px; height: max-content; }
    }

    /* ---------- Sections ---------- */
    .cardish {
      background: #fff;
      border: 1px solid var(--roamly-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: clamp(16px, 1.2vw + 10px, 24px);
    }
    .section-title {
      font-size: clamp(1.125rem, 0.6vw + 1rem, 1.5rem);
      font-weight: 700;
      color: var(--roamly-dark);
      margin: 0 0 14px;
    }

    .owner { display: flex; align-items: center; gap: 12px; }
    .owner img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; }
    .owner .name { font-weight: 600; color: var(--roamly-dark); }

    .description { color: var(--roamly-text); font-size: 1.05rem; line-height: 1.7; }

    .actions { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 14px; }
    @media (min-width: 520px) { .actions { grid-template-columns: repeat(3, max-content); } }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
      padding: 12px 18px; border-radius: 10px; border: 1px solid transparent; cursor: pointer;
      font-weight: 600; line-height: 1; transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }
    .btn:active { transform: translateY(1px); }
    .btn-danger { background: var(--roamly-red); color: #fff; border-color: var(--roamly-red); }
    .btn-danger:hover { background: #cc3e35; border-color: #cc3e35; color: #fff; }
    .btn-dark { background: #1f2327; color: #fff; border-color: #1f2327; }
    .btn-dark:hover { background: #000; color: #fff; }
    .btn-outline { background: #fff; color: var(--roamly-red); border-color: var(--roamly-red); }
    .btn-outline:hover { background: rgba(var(--roamly-red-rgb), .08); }

    /* ---------- Booking Card ---------- */
    .booking-card { box-shadow: var(--shadow-md); }
    .price { font-size: clamp(1.4rem, 1vw + 1rem, 1.8rem); font-weight: 800; color: var(--roamly-dark); }
    .price span { font-size: .95rem; font-weight: 500; color: var(--roamly-text-med); margin-left: 6px; }

    /* Mobile sticky booking bar */
    .mobile-booking-bar {
      position: sticky; bottom: 0; left: 0; right: 0;
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 12px;
      background: rgba(255,255,255,.85); backdrop-filter: saturate(180%) blur(10px);
      border-top: 1px solid var(--roamly-border);
      padding: 12px 16px; z-index: 20; border-radius: 12px 12px 0 0; box-shadow: 0 -6px 20px rgba(16,24,40,.08);
    }
    .mobile-booking-bar .price { margin: 0; }
    @media (min-width: 992px) { .mobile-booking-bar { display: none; } }

    /* ---------- Reviews ---------- */
    .reviews-wrap { display: grid; gap: 16px; }
    .review { border: 1px solid var(--roamly-border); border-radius: var(--radius); padding: 16px; background: #fff; box-shadow: var(--shadow-sm); }
    .review-head { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 12px; margin-bottom: 10px; }
    .review .avatar { width: 46px; height: 46px; border-radius: 50%; object-fit: cover; }
    .review .author { font-weight: 600; color: var(--roamly-dark); }
    .review .date { font-size: .9rem; color: var(--roamly-text-med); }
    .stars { color: #f5b301; font-size: .95rem; letter-spacing: 1px; }
    .review p { margin: 6px 0 0; color: var(--roamly-text); }
    .review-actions { display: flex; justify-content: flex-end; margin-top: 8px; }
    .btn-delete-review { display: inline-flex; align-items: center; gap: .4em; background: none; border: none; color: var(--roamly-text-med); padding: 6px 10px; font-size: .95rem; font-weight: 600; border-radius: 10px; cursor: pointer; }
    .btn-delete-review:hover { background: var(--roamly-red); color: #fff; box-shadow: 0 2px 8px rgba(var(--roamly-red-rgb), .28); }

    /* ---------- Review form ---------- */
    .review-form { background: var(--roamly-muted); border: 1px solid var(--roamly-border); }
    .form-input { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--roamly-border); font-size: 1rem; font-family: inherit; outline: none; transition: box-shadow .2s ease, border-color .2s ease; }
    .form-input:focus { border-color: rgba(var(--roamly-red-rgb), .7); box-shadow: 0 0 0 4px rgba(var(--roamly-red-rgb), .15); }
    textarea.form-input { resize: vertical; min-height: 120px; }

    .star-rating { display: inline-flex; flex-direction: row-reverse; gap: 4px; }
    .star-rating input[type="radio"] { display: none; }
    .star-rating label { font-size: 28px; color: #c7c7c7; cursor: pointer; transition: transform .15s ease, color .15s ease; }
    .star-rating input[type="radio"]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: #f5b301; }
    .star-rating label:hover { transform: scale(1.06); }

    .invalid-feedback { display: none; font-size: .9rem; color: var(--roamly-red); margin-top: 6px; }
    .is-invalid + .invalid-feedback { display: block; }

    /* ---------- Map ---------- */
    #map { width: 100%; height: 340px; border: 1px solid var(--roamly-border); border-radius: var(--radius); overflow: hidden; }
    @media (max-width: 480px) { #map { height: 260px; } }

    /* Utility */
    .muted { color: var(--roamly-text-med); }
    hr { border: 0; border-top: 1px solid var(--roamly-border); margin: 24px 0; }
  </style>
</head>
<body>
  <div class="page-container">
    <header class="listing-header">
      <h1 class="listing-title"><%= listing.title %></h1>
      <div class="listing-location"><i class="fa-solid fa-location-dot"></i> <span><%= listing.location %>, <%= listing.country %></span></div>
    </header>

    <!-- Gallery -->
    <div class="gallery">
      <img
        src="<%= listing.image?.url || 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=1600&h=900&fit=crop' %>"
        alt="Listing image"
        loading="lazy"
        onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=1600&h=900&fit=crop';"
      />
    </div>

    <!-- Mobile sticky booking bar -->
    <div class="mobile-booking-bar cardish" id="mobileBookingBar">
      <p class="price">₹<%= listing.price ? listing.price.toLocaleString('en-IN') : 'N/A' %><span>/ night</span></p>
      <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#bookModal"><i class="fa-regular fa-calendar-days"></i> Book</button>
    </div>

    <main class="layout" aria-label="Listing details">
      <section class="content">
        <div class="cardish">
          <div class="owner" aria-label="Host details">
            <img src="<%= listing.owner?.avatar || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %>" alt="Host avatar" loading="lazy" />
            <div>
              <div class="name">Hosted by <%= listing.owner?.username || 'Host' %></div>
              <div class="muted">Verified host</div>
            </div>
          </div>
          <hr />
          <p class="description"><%= listing.description %></p>

          <% if (currUser && listing.owner && (listing.owner._id.equals(currUser._id) || currUser.username === 'sujalbhatt')) { %>
            <div class="actions">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark"><i class="fa-regular fa-pen-to-square"></i> Edit</a>
              <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" onsubmit="return confirm('Delete this listing?');">
                <button type="submit" class="btn btn-outline"><i class="fa-regular fa-trash-can"></i> Delete</button>
              </form>
            </div>
          <% } %>
        </div>

        <hr />

        <!-- Reviews -->
        <section aria-label="Reviews">
          <h2 class="section-title">Reviews</h2>
          <% if (listing.reviews?.length > 0) { %>
            <div class="reviews-wrap">
              <% listing.reviews.forEach(review => { %>
                <article class="review" aria-label="Review">
                  <div class="review-head">
                    <img class="avatar" src="<%= review.author?.avatar || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' %>" alt="Reviewer avatar" loading="lazy" />
                    <div>
                      <div class="author"><%= review.author?.username || 'Anonymous' %></div>
                      <div class="stars" aria-label="Rating">
                        <% for (let i = 1; i <= 5; i++) { %>
                          <% if (i <= review.rating) { %>
                            <i class="fas fa-star" aria-hidden="true"></i>
                          <% } else { %>
                            <i class="far fa-star" aria-hidden="true"></i>
                          <% } %>
                        <% } %>
                      </div>
                    </div>
                    <small class="date"><%= new Date(review.createdAt).toLocaleDateString() %></small>
                  </div>
                  <p><%= review.comment %></p>
                  <% if (currUser && review.author?._id && review.author._id.equals(currUser._id)) { %>
                    <div class="review-actions">
                      <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" onsubmit="return confirm('Delete this review?');">
                        <button type="submit" class="btn-delete-review"><i class="fa-regular fa-trash-can"></i> Delete</button>
                      </form>
                    </div>
                  <% } %>
                </article>
              <% }) %>
            </div>
          <% } else { %>
            <p class="muted">No reviews yet.</p>
          <% } %>
        </section>

        <hr />

        <!-- Leave a Review -->
        <section aria-label="Leave a review">
          <% if (currUser) { %>
            <div class="cardish review-form">
              <h2 class="section-title" style="margin-bottom: 8px;">Leave a Review</h2>
              <form id="reviewForm" action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
                <div class="mb-3">
                  <label class="form-label">Rating</label>
                  <div class="star-rating">
                    <input type="radio" name="review[rating]" value="5" id="star5" required /><label for="star5">★</label>
                    <input type="radio" name="review[rating]" value="4" id="star4" /><label for="star4">★</label>
                    <input type="radio" name="review[rating]" value="3" id="star3" /><label for="star3">★</label>
                    <input type="radio" name="review[rating]" value="2" id="star2" /><label for="star2">★</label>
                    <input type="radio" name="review[rating]" value="1" id="star1" /><label for="star1">★</label>
                  </div>
                  <div id="rating-error" class="invalid-feedback">Please select a rating.</div>
                </div>
                <div class="mb-3">
                  <label for="comment" class="form-label">Comments</label>
                  <textarea class="form-input" name="review[comment]" id="comment" rows="4" required></textarea>
                  <div class="invalid-feedback">Please enter your comment.</div>
                </div>
                <button type="submit" class="btn btn-dark"><i class="fa-regular fa-paper-plane"></i> Submit Review</button>
              </form>
            </div>
          <% } else { %>
            <div class="cardish" style="text-align:center; background:#fff8f7; border-color: rgba(var(--roamly-red-rgb),.2);">
              <h3 class="section-title" style="margin:0 0 6px;">Want to share your experience?</h3>
              <p class="muted">Please <a href="/login?returnTo=/listings/<%= listing._id %>">log in</a> to leave a review.</p>
              <a href="/login?returnTo=/listings/<%= listing._id %>" class="btn btn-danger" style="margin-top:8px;">Login</a>
            </div>
          <% } %>
        </section>

        <hr />

        <!-- Map -->
        <section aria-label="Map">
          <h2 class="section-title">Where you'll be</h2>
          <div id="map"></div>
        </section>
      </section>

      <!-- Sidebar (desktop) -->
      <aside class="sidebar">
        <div class="cardish booking-card">
          <p class="price">₹<%= listing.price ? listing.price.toLocaleString('en-IN') : 'N/A' %><span>/ night</span></p>
          <button type="button" class="btn btn-danger w-100 mt-2" data-bs-toggle="modal" data-bs-target="#bookModal">
            <i class="fa-regular fa-calendar-days"></i> Book Now
          </button>
        </div>
      </aside>
    </main>
  </div>

  <!-- Booking Modal -->
  <div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST" action="/bookings/create/<%= listing._id %>" id="bookingForm" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="bookModalLabel">Book Your Stay</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="dateRange" class="form-label">Select Dates</label>
            <input type="text" id="dateRange" class="form-input" required autocomplete="off" placeholder="Select check-in and check-out dates" />
            <input type="hidden" name="startDate" id="startDate" required />
            <input type="hidden" name="endDate" id="endDate" required />
            <div class="invalid-feedback" id="dateRangeFeedback">Please select a valid date range.</div>

            <% if (listing.bookedDates?.length > 0) { const formattedBookedDates = listing.bookedDates.map(d => new Date(d).toLocaleDateString('en-CA')); %>
              <div class="mt-3 p-3" style="font-size:.93rem; color: var(--roamly-text-med); background: var(--roamly-muted); border:1px dashed var(--roamly-border); border-radius: 12px;">
                <strong style="color:var(--roamly-dark)">Currently Unavailable:</strong><br />
                <%
                  let ranges = [];
                  if (formattedBookedDates.length > 0) {
                    formattedBookedDates.sort();
                    let startRange = formattedBookedDates[0];
                    let endRange = formattedBookedDates[0];
                    for (let i = 1; i < formattedBookedDates.length; i++) {
                      const currentDate = new Date(formattedBookedDates[i]);
                      const previousDate = new Date(endRange);
                      const nextDay = new Date(previousDate);
                      nextDay.setDate(previousDate.getDate() + 1);
                      if (currentDate.toISOString().split('T')[0] === nextDay.toISOString().split('T')[0]) {
                        endRange = formattedBookedDates[i];
                      } else {
                        ranges.push(startRange === endRange ? new Date(startRange).toLocaleDateString() : `${new Date(startRange).toLocaleDateString()} - ${new Date(endRange).toLocaleDateString()}`);
                        startRange = formattedBookedDates[i];
                        endRange = formattedBookedDates[i];
                      }
                    }
                    ranges.push(startRange === endRange ? new Date(startRange).toLocaleDateString() : `${new Date(startRange).toLocaleDateString()} - ${new Date(endRange).toLocaleDateString()}`);
                  }
                %>
                <%- ranges.join('<br>') %>
              </div>
            <% } %>
          </div>
          <div class="modal-footer" style="background: var(--roamly-muted);">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Confirm Booking</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- Booking Datepicker ---
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const dateRangeInput = document.getElementById('dateRange');
      const dateRangeFeedback = document.getElementById('dateRangeFeedback');
      const bookedDates = <%- JSON.stringify(activeBookedDates) %> || [];

      const fp = flatpickr('#dateRange', {
        mode: 'range',
        minDate: 'today',
        dateFormat: 'Y-m-d',
        disable: bookedDates,
        onChange: function(selectedDates, dateStr, instance) {
          if (selectedDates.length === 2) {
            const [start, end] = selectedDates;
            const s = start.toISOString().split('T')[0];
            const e = end.toISOString().split('T')[0];
            startDateInput.value = s; endDateInput.value = e;
            dateRangeInput.value = `${s} to ${e}`;
            dateRangeInput.classList.remove('is-invalid');
            dateRangeFeedback.style.display = 'none';

            // ensure the selected range doesn't include disabled dates
            let valid = true;
            for (let i = 0; i < bookedDates.length; i++) {
              const b = new Date(bookedDates[i]);
              if (b >= start && b <= end) { valid = false; break; }
            }
            if (!valid) {
              instance.clear();
              startDateInput.value = '';
              endDateInput.value = '';
              dateRangeInput.value = '';
              dateRangeInput.classList.add('is-invalid');
              dateRangeFeedback.textContent = 'Selected range includes unavailable dates.';
              dateRangeFeedback.style.display = 'block';
            }
          } else {
            startDateInput.value = '';
            endDateInput.value = '';
          }
        }
      });

      // --- Booking Form Validation ---
      const bookingForm = document.getElementById('bookingForm');
      if (bookingForm) {
        bookingForm.addEventListener('submit', function(event) {
          if (!startDateInput.value || !endDateInput.value) {
            dateRangeInput.classList.add('is-invalid');
            dateRangeFeedback.textContent = 'Please select both check-in and check-out dates.';
            dateRangeFeedback.style.display = 'block';
            event.preventDefault();
            event.stopPropagation();
          } else {
            dateRangeInput.classList.remove('is-invalid');
            dateRangeFeedback.style.display = 'none';
          }
        }, false);
      }

      // --- Review Form Validation ---
      const reviewForm = document.getElementById('reviewForm');
      if (reviewForm) {
        const ratingError = document.getElementById('rating-error');
        reviewForm.addEventListener('submit', function(event) {
          const selectedRating = reviewForm.querySelector('input[name="review[rating]"]:checked');
          if (!selectedRating) {
            ratingError.style.display = 'block';
            event.preventDefault();
            event.stopPropagation();
          } else {
            ratingError.style.display = 'none';
          }
          // HTML5 validations
          if (!reviewForm.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          reviewForm.classList.add('was-validated');
        }, false);
      }

      // --- MapLibre Map ---
      const apiKey = "<%= MAPTILER_API_KEY %>";
      if (typeof maplibregl !== 'undefined' && apiKey) {
        let center = [78.9629, 20.5937]; // Default India
        <% if (listing.geometry?.coordinates?.length === 2) { %>
          center = [<%= listing.geometry.coordinates[0] %>, <%= listing.geometry.coordinates[1] %>];
        <% } %>

        const map = new maplibregl.Map({
          container: 'map',
          style: `https://api.maptiler.com/maps/streets/style.json?key=${apiKey}`,
          center: center,
          zoom: 12
        });
        map.addControl(new maplibregl.NavigationControl());
        new maplibregl.Marker().setLngLat(center).addTo(map);
      }
    });
  </script>
</body>
</html>


